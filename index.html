<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - Пеликан Алаколь</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    <style>
        /* ВСЁ СТИЛИ ЗДЕСЬ */
        :root {
            --primary: #2c3e50; --secondary: #3498db; --success: #27ae60;
            --danger: #e74c3c; --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui; 
            background: #f8f9fa; 
            color: var(--dark);
        }
        .admin-container { 
            display: flex; 
            height: 100vh; 
            background: white;
        }
        .sidebar { 
            width: 250px; 
            background: var(--primary); 
            color: white;
            padding: 20px;
        }
        .sidebar h2 { margin-bottom: 20px; }
        .sidebar ul { list-style: none; }
        .sidebar li { 
            padding: 12px; 
            margin: 5px 0; 
            border-radius: 6px;
            cursor: pointer;
        }
        .sidebar li.active { background: var(--secondary); }
        .sidebar li:hover { background: #34495e; }
        .content { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto;
        }
        .editor { 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            margin-right: 10px;
        }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .notification {
            position: fixed; top: 20px; right: 20px;
            padding: 15px; background: var(--success); color: white;
            border-radius: 4px; display: none;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Боковая панель -->
        <div class="sidebar" id="sidebar">
            <h2><i class="fas fa-cog"></i> Панель управления</h2>
            <ul id="menu"></ul>
        </div>

        <!-- Основной контент -->
        <div class="content">
            <div id="editor-area">
                <h1>Добро пожаловать в админ-панель</h1>
                <p>Выберите раздел для редактирования</p>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div class="notification" id="notification"></div>

    <!-- ВСЁ JS КОД ЗДЕСЬ -->
    <script>
        class PelikanAdmin {
            constructor() {
                this.config = window.ADMIN_CONFIG;
                this.currentTab = 'activities';
                this.content = {};
                this.token = localStorage.getItem('github_token');
            }

            init() {
                this.renderMenu();
                this.loadContent();
                this.setupEventListeners();
            }

            renderMenu() {
                const menu = document.getElementById('menu');
                this.config.contentTypes.forEach(type => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-${this.getIcon(type)}"></i> ${this.config.names[type]}`;
                    li.onclick = () => this.switchTab(type);
                    menu.appendChild(li);
                });
            }

            getIcon(type) {
                const icons = {
                    activities: 'calendar-alt',
                    news: 'newspaper',
                    gallery: 'images',
                    menu: 'th-large',
                    weather: 'cloud-sun',
                    offers: 'gift'
                };
                return icons[type] || 'file';
            }

            async switchTab(tab) {
                this.currentTab = tab;
                
                // Обновляем активный пункт меню
                document.querySelectorAll('#menu li').forEach(li => li.classList.remove('active'));
                event.target.classList.add('active');

                // Загружаем и отображаем контент
                await this.loadTabContent(tab);
            }

            async loadContent() {
                for (const type of this.config.contentTypes) {
                    try {
                        const response = await this.fetchFromGitHub(`${this.config.repo.contentPath}/${type}.json`);
                        this.content[type] = await response.json();
                    } catch (error) {
                        console.error(`Ошибка загрузки ${type}:`, error);
                        this.content[type] = this.getDefaultContent(type);
                    }
                }
            }

            async loadTabContent(tab) {
                const editorArea = document.getElementById('editor-area');
                
                switch(tab) {
                    case 'activities':
                        editorArea.innerHTML = this.renderActivitiesEditor();
                        break;
                    case 'news':
                        editorArea.innerHTML = this.renderNewsEditor();
                        break;
                    default:
                        editorArea.innerHTML = `<h2>Редактор для ${this.config.names[tab]}</h2>`;
                }
            }

            renderActivitiesEditor() {
                const activities = this.content.activities?.activities || [];
                
                return `
                    <div class="editor">
                        <h2><i class="fas fa-calendar-alt"></i> Редактор активностей</h2>
                        
                        <button class="btn btn-primary" onclick="admin.addActivity()">
                            <i class="fas fa-plus"></i> Добавить активность
                        </button>
                        
                        <div id="activities-list">
                            ${activities.map((activity, index) => `
                                <div class="activity-form" style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 6px;">
                                    <h4>Активность #${index + 1}</h4>
                                    <div class="form-group">
                                        <label>Время</label>
                                        <input type="text" value="${activity.time || ''}" 
                                               onchange="admin.updateActivity(${index}, 'time', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>Название</label>
                                        <input type="text" value="${activity.name || ''}" 
                                               onchange="admin.updateActivity(${index}, 'name', this.value)">
                                    </div>
                                    <div class="form-group">
                                        <label>Место</label>
                                        <input type="text" value="${activity.location || ''}" 
                                               onchange="admin.updateActivity(${index}, 'location', this.value)">
                                    </div>
                                    <button class="btn btn-danger" onclick="admin.deleteActivity(${index})">
                                        <i class="fas fa-trash"></i> Удалить
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="btn btn-success" onclick="admin.saveActivities()">
                            <i class="fas fa-save"></i> Сохранить все изменения
                        </button>
                    </div>
                `;
            }

            addActivity() {
                if (!this.content.activities) this.content.activities = { activities: [] };
                if (!this.content.activities.activities) this.content.activities.activities = [];
                
                this.content.activities.activities.push({
                    time: "Новое время",
                    name: "Новая активность", 
                    location: "Место проведения"
                });
                
                this.loadTabContent('activities');
                this.showNotification('Активность добавлена');
            }

            updateActivity(index, field, value) {
                this.content.activities.activities[index][field] = value;
            }

            deleteActivity(index) {
                if (confirm('Удалить эту активность?')) {
                    this.content.activities.activities.splice(index, 1);
                    this.loadTabContent('activities');
                    this.showNotification('Активность удалена');
                }
            }

            async saveActivities() {
                try {
                    await this.saveToGitHub('activities.json', this.content.activities);
                    this.showNotification('Активности сохранены!');
                } catch (error) {
                    this.showNotification('Ошибка сохранения: ' + error.message, 'error');
                }
            }

            async fetchFromGitHub(path) {
                if (!this.token) throw new Error('GitHub токен не настроен');
                
                const url = `https://api.github.com/repos/${this.config.repo.owner}/${this.config.repo.repo}/contents/${path}?ref=${this.config.repo.branch}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `token ${this.token}` }
                });
                
                if (!response.ok) throw new Error('Ошибка загрузки');
                return response;
            }

            async saveToGitHub(filename, content) {
                if (!this.token) throw new Error('GitHub токен не настроен');
                
                const path = `${this.config.repo.contentPath}/${filename}`;
                const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));
                
                // Получаем текущий SHA файла
                let sha = null;
                try {
                    const existing = await this.fetchFromGitHub(path);
                    const data = await existing.json();
                    sha = data.sha;
                } catch (error) {
                    // Файл не существует - создаем новый
                }
                
                const response = await fetch(`https://api.github.com/repos/${this.config.repo.owner}/${this.config.repo.repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `admin: Update ${filename}`,
                        content: contentBase64,
                        branch: this.config.repo.branch,
                        sha: sha
                    })
                });
                
                if (!response.ok) throw new Error('Ошибка сохранения');
                return response.json();
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.background = type === 'error' ? 'var(--danger)' : 'var(--success)';
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            setupEventListeners() {
                // Настройка токена
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'k') {
                        e.preventDefault();
                        this.setupToken();
                    }
                });
            }

            setupToken() {
                const token = prompt('Введите GitHub Personal Access Token:');
                if (token) {
                    localStorage.setItem('github_token', token);
                    this.token = token;
                    this.showNotification('Токен сохранен!');
                }
            }

            getDefaultContent(type) {
                const defaults = {
                    activities: { activities: [] },
                    news: { news: [] },
                    gallery: { galleries: [] },
                    menu: { menuItems: [] },
                    weather: { weather: {} },
                    offers: { offers: [] }
                };
                return defaults[type];
            }
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            window.admin = new PelikanAdmin();
            window.admin.init();
        });
    </script>
</body>
</html>
